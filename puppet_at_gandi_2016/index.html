<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Baloo+Bhaina);
      @import url(https://fonts.googleapis.com/css?family=Droid+Sans:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Sans';
      }
      h1, h2, h3 {
        font-family: 'Baloo Bhaina';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-slide-content {
        font-size: 2em;
      }
      .front { background-color: #000; color: #fff; }
      .bio {
        background-color: transparent;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle, front

# Puppet @ Gandi

DevOps Taiwan Meetup  
november 2016

---


# mose

- DevOps at Gandi Asia since 2014

- Taiwanese since 2008

- http://mose.com

- https://github.com/mose

---
![gandi.net](img/Puppet-Logo-Amber-Black-sm.png)

- Configuration Management Framework
- extensible and modular
- not orchestrator
- not lightweight


- writen in Ruby
- ... but no ruby knowledge needed
- https://puppetlabs.com

---
![gandi.net](img/Gandi_logo_black.jpg)

- Domain Names Registrar, 2M domains
- Hosting VPS, PaaS, Mail
- 1,600 servers in 4 Datacenters
- Debian, Nexenta and FreeBSD
- 15 devops in charge


- Created in 2001 in France
- Gandi Asia in Taipei in 2014
- https://gandi.net

---
# Why Puppet at Gandi

- Gandi started using puppet in 2009
- Gandi is more a python shop
- but puppet is (almost) language agnostic
- .. with a complete DSL


- Debian packaging (debian/nexenta)
- or FreeBSD pkg-ng
- deployment is a done by system update
- ... with Puppet

---
# Puppet specifics

- nodes pull configuration and send facts to a central server (puppetmaster)
- DSL is simple (Gandi is a python shop, no ruby ninjas needed)
- Descriptive and Idempotent
- Popular and widely supported

---
# How Puppet at Gandi

- usage of Hiera
- inventory in ENC
- custom modules
- puppet 3.6 with puppetdb
- automated puppet-lint with jenkins
- arbitrary branches (environment)
- gitlab workflow with MRs
- monitoring with Nagios

???
This is the result of 7 years opf evolution
- 2009 -> only few people use it because lack of clear conventions
- 2011 -> simple module template
- 2015 -> use of yaml ENC files
---
# How it works

```
.-------------.
| environment |---------------------------.
'-------------'                           |
  | .----------.        .--------------.  |
  | | ENC file |--------| farm_modules |  |
  | '----------'        '--------------'  |
  |       |                    |          |
  |       |                    |          |
  | .------------.        .---------.     |
  | | hiera file |        | module1 |     |    .------------.
  | | hiera file |        | module2 |--------> | puppet run |
  | | hiera file |        | module3 |     |    '------------'
  | '------------'        '---------'     |
  |       |                    |          |
  |       '------> params -----'          |
  '---------------------------------------'
```
???
- Environment is not dev/stage/prod
- environment is about branches and MRs
- each node/server has one ENC
- we have 1600 ENC files

---
# External Nodes Classifier

- declaration of node (serveur)
- definition of what params apply

```bash
$ cat enc/consul1.gandi.yaml
---
classes:
  - consulnode       # <-- farm_modules/consulnode/manifests/init.pp
parameters:
  country: lu        # <-- params/country/lu.yaml
  datacenter: dc2    # <-- params/datacenter/dc2.yaml
  farm: consulnode   # <-- params/farm/consulnode.yaml
```

---
# Hiera Config

```yaml
:backends:
  - yaml
:hierarchy:
  - "nodes/%{fqdn}"
  - "farm_datacenter_flavor/%{farm}_%{datacenter}_%{farm_flavor}"
  - "farm_datacenter_step/%{farm}_%{datacenter}_%{step}"
  - "farm_datacenter/%{farm}_%{datacenter}"
  - "farm_flavor_step/%{farm}_%{farm_flavor}_%{step}"
  - "farm_flavor/%{farm}_%{farm_flavor}"
  - "farm_step/%{farm}_%{step}"
  - "farm/%{farm}"
  - "room/%{room}"
  - "datacenter_virtualdc/%{datacenter}_%{virtualdc}"
  - "datacenter/%{datacenter}"
  - "country/%{country}"
  - "os-lsb/%{operatingsystem}-%{lsbdistcodename}"
  - "os/%{operatingsystem}"
  - "common/common"
:merge_behavior: deeper

```

---
# Hiera file example

```yaml
apt_config:
  experimental:
    enabled: "true"

monitoring_config:
  default:
    host:
      contact_groups: "stage_platform"
    service:
      contact_groups: "stage_platform"
```
???
- this is an example of a node params file

---
# hiera(rchy)

```bash
[-] (merged)
[0] params/farm_datacenter/monworker_dc2.yaml
[1] params/farm/monworker.yaml
[2] params/datacenter/dc2.yaml
[3] params/os/Debian.yaml
[4] params/common/common.yaml

[1] collectd_config.additional_plugins ["tcpconns"]
[3] collectd_config.generic_plugins ["vmem"]
[3] collectd_config.plugin_disk ["/^sd/"]
[1] collectd_config.plugin_tcpconns []
[1] collectd_config.plugin_tcpconns_remote ["4730"]
[1] monitoring_config.dependencies ["libsnmp-ruby1.8", "rpcbind"]
[0] monitoring_config.services_nrpe.proc_worker_bissen-master-pra.check_command check_procs -u nagios -c 3: -a worker_bissen-master-pra
[0] monitoring_config.services_nrpe.proc_worker_bissen-master-pra.use generic-service
[-] monworker_classes ["gandi_hosting_vm"]
    [0] monworker_classes ["gandi_hosting_vm"]
    [1] monworker_classes []
...
```
???
Sample of output of [Hieracles](https://github.com/Gandi/hieracles)

---
# Farm_modules

- 310 modules (all custom)

```bash
# consulnode farm
class consulnode {
    include base_modules
    include ssmtp
    include sysctl
    include snmpd
    include collectd
    include monitoring

    include consul   # <-- modules/consul/
}
```

---
# Modules

```bash
modules/consul
├── files
│   └── default
├── manifests
│   ├── config.pp
│   ├── cron.pp
│   ├── files.pp
│   ├── init.pp
│   ├── install.pp
│   ├── service.pp
│   └── user.pp
├── README
└── templates
    └── default
        └── etc
            ├── consul.d
            │   └── 42-gandi.json.erb
            └── default
                └── consul.erb
```

---
# Manifests

```ruby
# consul::files handles static/blob files
class consul::files inherits globals::files {
    motd::register{ $name: }

    # default options for file provider
    File {
        require => Class['consul::install'],
        notify  => Class['consul::service']
    }

    file {
        '/srv/consul':
            ensure => directory,
            owner  => 'consul',
            group  => 'consul';
    }
}
```

---
# Extra Puppet Tools

- Facter (gets facts)
- puppetdb (can be curl'ed)
- mcollective (batch operations)
- hieracles (CLI to find hierarchy overrides)
- Hieraviz (hieracles in a web browser)
- Ansible (yeah, for provisionning and orchestration)

---
class: center, middle, front

Thanks!

# Any question?

    </textarea>
    <script src="../js/remark-0.14.0.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
