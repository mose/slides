<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Baloo+Bhaina);
      @import url(https://fonts.googleapis.com/css?family=Droid+Sans:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Sans';
      }
      h1, h2, h3 {
        font-family: 'Baloo Bhaina';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-slide-content {
        font-size: 2em;
      }
      .front { background-color: #000; color: #fff; }
      .bio {
        background-color: transparent;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle, front

# Puppet @ Gandi

DevOps Taiwan Meetup  
november 2016

---


# mose

- DevOps at Gandi Asia since 2014

- Taiwanese since 2008

- http://mose.com

- https://github.com/mose

---
![gandi.net](img/Puppet-Logo-Amber-Black-sm.png)

- Configuration Management Framework
- extensible
- Modular
- not orchestrator
- not lightweight

- writen in Ruby
- ... but no ruby knowledge needed
- https://puppetlabs.com

---
![gandi.net](img/Gandi_logo_black.jpg)

- Domain Names Registrar, 2M domains
- Hosting VPS, PaaS, Mail
- 1,600 servers in 4 Datacenters
- Debian, Nexenta and FreeBSD
- 20 devops in charge

- Created in 2001 in France
- Gandi Asia in Taipei in 2014
- https://gandi.net

---
# Why Puppet at Gandi

- Gandi started using puppet in 2009
- Gandi is more a python shop
- but puppet is (almost) language agnostic
- .. with a complete DSL


- Debian packaging (debian/nexenta)
- or FreeBSD pkg-ng
- deployment is a done by system update
- ... with Puppet

---
# Puppet specifics

- nodes pull configuration and send facts to a central server (puppetmaster)
- DSL is simple (Gandi is a python shop, no ruby ninjas needed)
- Descriptive and Idempotent
- Popular and widely supported

---
# How Puppet at Gandi

- usage of Hiera
- inventory in ENC
- custom modules
- puppet 3.6 with puppetdb
- automated puppet-lint with jenkins
- arbitrary branches
- gitlab workflow
- monitoring with Nagios

---
# Global architecture

```
.----------.        .--------------.
| ENC file |--------| farm_modules |
'----------'        '--------------'
      |                    |
      |                    |
.------------.        .---------.
| hiera file |        | module1 |     .------------.
| hiera file |        | module2 |---> | puppet run |
| hiera file |        | module3 |     '------------'
'------------'        '---------'
      |                     |
      '------> params ------'
```
---
# Hiera

- Hierachic declaration of variables
- inventory file declares farms
- farms per
  - type of services
  - datacenter
  - country
  - OS
  - etc ..

---
# Hiera Config

```yaml
:backends:
  - yaml
:hierarchy:
  - "nodes/%{fqdn}"
  - "farm_datacenter_flavor/%{farm}_%{datacenter}_%{farm_flavor}"
  - "farm_datacenter_step/%{farm}_%{datacenter}_%{step}"
  - "farm_datacenter/%{farm}_%{datacenter}"
  - "farm_flavor_step/%{farm}_%{farm_flavor}_%{step}"
  - "farm_flavor/%{farm}_%{farm_flavor}"
  - "farm_step/%{farm}_%{step}"
  - "farm/%{farm}"
  - "room/%{room}"
  - "datacenter_virtualdc/%{datacenter}_%{virtualdc}"
  - "datacenter/%{datacenter}"
  - "country/%{country}"
  - "os-lsb/%{operatingsystem}-%{lsbdistcodename}"
  - "os/%{operatingsystem}"
  - "common/common"
:yaml:
  :datadir: "/srv/puppet/branches/%{::environment}/params/"
:puppet:
  :datasource: data
:merge_behavior: deeper

```

---
# External Nodes Classifier

- declaration of node (serveur)
- definition of what params apply

```bash
$ cat enc/consul1.bi1.0x35.net.yaml
---
classes:
  - consulnode       # <-- farm_modules/consulnode/manifests/init.pp
parameters:
  country: lu        # <-- params/country/lu.yaml
  datacenter: dc2    # <-- params/datacenter/dc2.yaml
  farm: consulnode   # <-- params/farm/consulnode.yaml
```
- 310 modules

---
# Hiera file example

```yaml
apt_config:
  experimental:
    enabled: "true"

monitoring_config:
  default:
    host:
      contact_groups: "stage_platform"
    service:
      contact_groups: "stage_platform"
```

---
# Farm_modules

```bash
# consulnode farm
class consulnode {
    include base_modules
    include ssmtp
    include sysctl
    include snmpd
    include collectd
    include monitoring

    include consul   # <-- modules/consul/
}
```

---
# Modules

```bash
modules/consul
├── files
│   └── default
├── manifests
│   ├── config.pp
│   ├── cron.pp
│   ├── files.pp
│   ├── init.pp
│   ├── install.pp
│   ├── service.pp
│   └── user.pp
├── metadata.json
├── README
└── templates
    └── default
        └── etc
            ├── consul.d
            │   └── 42-gandi.json.erb
            └── default
                └── consul.erb
```

---
# Manifests

```ruby
# consul::files handles static/blob files
class consul::files inherits globals::files {
    motd::register{ $name: }

    # default options for file provider
    File {
        require => Class['consul::install'],
        notify  => Class['consul::service']
    }

    file {
        '/srv/consul':
            ensure => directory,
            owner  => 'consul',
            group  => 'consul';
    }
}
```

---
# Extra Puppet Tools

- many extra tools available

---
# Facter

```
$ facter
[...]
kernelversion => 3.14.43
lsbdistcodename => jessie
lsbdistdescription => Debian GNU/Linux 8.1 (jessie)
lsbdistid => Debian
lsbdistrelease => 8.1
lsbmajdistrelease => 8
[...]
country => fr
datacenter => equinix
diskdrives => sda,sdb
diskid_765bc821-a587-45ac-a352-400d2ff8cc0e => sdb
diskid_d17a4911-c56d-40a8-b8bd-17570826e82e => sda
diskmodel_sda => QEMU HARDDISK   
diskmodel_sdb => QEMU HARDDISK   
diskscheduler_sda => deadline
diskscheduler_sdb => deadline
[...]
```

---
# Mcollective


    </textarea>
    <script src="../js/remark-0.14.0.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
